<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DualLift Competition Dashboard (Prototype)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', arial, sans-serif; background: #f7f8fa; margin: 0; }
    h1 { text-align: center; padding: 1rem; background: #1976d2; color: #fff; margin: 0 0 1rem 0;}
    nav { background: #eee; padding: 0.5rem; display: flex; justify-content: center; gap:1rem; border-bottom: 1px solid #ddd;}
    nav a { padding: 0.5rem 1.2rem; border-radius: 4px; color: #1976d2; text-decoration: none; font-weight: bold;}
    nav a.active,nav a:focus { background: #1976d2; color: #fff;}
    section { display:none; max-width: 1100px; margin: auto; margin-top: 1rem; background: #fff; padding: 1rem 1.5rem 2rem 1.5rem; border-radius: 8px; box-shadow: 0 3px 12px #ccc}
    section.active { display:block;}
    label { display:block; margin-top: 0.5rem;}
    input,select,button { margin-top: 0.2rem; padding: 0.45rem; font-size: 1rem;}
    table { border-collapse:collapse; width:100%; margin-top: 1rem;}
    th,td { padding: 0.5rem 0.4rem; border: 1px solid #ddd; text-align:center;}
    th { background: #f1f5fa;}
    .flex { display:flex; gap:2rem; flex-wrap:wrap;}
    .half { flex:1 1 350px; max-width: 560px;}
    fieldset { border:1px solid #cacaca; padding: 10px; margin-bottom: 1.5rem;}
    .decision-good{ color:green; font-weight:bold;}
    .decision-no{ color:red; font-weight:bold;}
    .decision-review{ color:goldenrod; font-weight: bold;}
    .barbell { margin:1rem 0; display: flex; align-items: center;}
    .plate { display: inline-block; border-radius: 2px; margin-right: 4px; font-size:1rem; min-width:32px; font-weight:bold; text-align:center; color:#fff; padding:2px 8px;}
    .red{ background:#d32f2f;}
    .blue{background:#1976d2;}
    .yellow{background:#fbc02d; color:#333;}
    .green{background: #42b983;}
    .white{background:white; color:#111; border:1px solid #333;}
    .gray{background:#727272;}
    .timer-display{ font-size:2.8rem; text-align:center; font-weight:bold; margin:1rem 0;}
    .filters{ margin: 1rem 0; display: flex; gap: 1rem; align-items: center;}
    .cat-header{ background: #e3ecfc; color:#1976d2; font-weight: bold; font-size: 1rem;}
    .div-header{ background: #faf7de; color:#bf9400;}
    @media(max-width:900px){
      .flex{ flex-direction: column;}
      .half{ max-width: 100%; }
    }
  </style>
</head>
<body>
<h1>DualLift Competition Dashboard</h1>
<nav>
  <a href="#" id="nav-main" class="active">Main Menu</a>
  <a href="#audience" id="nav-audience">Audience Display</a>
  <a href="#scoreboard" id="nav-scoreboard">Scoreboard</a>
  <a href="#control" id="nav-control">Control Panel</a>
</nav>

<!-- MAIN MENU -->
<section id="main-menu" class="active">
  <h2>Welcome!</h2>
  <p>This dashboard helps you run Powerlifting and Olympic Weightlifting events with separate scoreboards, filtering by category/division, live barbell visuals, and more.</p>
  <ul>
    <li>Organize lifters by category and division for either event type</li>
    <li>Log attempts quickly with single-click decisions</li>
    <li>Audience and judges see a live, visual display of the barbell</li>
    <li>Automatic Sinclair & Wilks scoring</li>
    <li>Flexible views for audience, operators, and management</li>
  </ul>
  <fieldset>
    <legend>Quick Navigation</legend>
    <div>
      <a href="#audience" id="menu-link-audience">Open Audience Display</a>
      <a href="#scoreboard" id="menu-link-scoreboard">Open Scoreboard</a>
      <a href="#control" id="menu-link-control">Open Control Panel</a>
    </div>
  </fieldset>
  <fieldset>
    <legend>Choose Event Type</legend>
    <label>
      Competition Type:
      <select id="event-type-select">
        <option value="">-- Choose --</option>
        <option value="olympic">Olympic Weightlifting</option>
        <option value="powerlifting">Powerlifting</option>
      </select>
    </label>
    <div id="event-setup-area" style="margin-top:1rem; display:none;">
      <label>
        Competition Name:
        <input type="text" id="competition-name" placeholder="e.g. Ropar Open 2025">
      </label>
      <label>
        Categories (comma separated, e.g. 73,81,89):
        <input type="text" id="category-list" placeholder="e.g. 73,81,89">
      </label>
      <button id="setup-confirm-btn">Setup Competition</button>
      <div id="setup-msg"></div>
    </div>
  </fieldset>
</section>

<!-- AUDIENCE DISPLAY -->
<section id="audience-display">
  <h2>Audience Display</h2>
  <div><strong>Current Lifter:</strong> <span id="aud-cur-lifter">---</span></div>
  <div><strong>Attempt Weight:</strong> <span id="aud-cur-weight">---</span> kg</div>
  <div class="timer-display" id="aud-timer">60</div>
  <div id="aud-barbell" class="barbell"></div>
  <div><strong>Referee Decision:</strong> <span id="aud-decision">Waiting</span></div>
</section>

<!-- SCOREBOARD -->
<section id="scoreboard-display">
  <h2>Scoreboard</h2>
  <div class="filters">
    <label>Show Category:
      <select id="score-cat-filter" multiple size="1"></select>
    </label>
    <label>Show Division:
      <select id="score-div-filter" multiple>
        <option value="A" selected>A</option>
        <option value="B" selected>B</option>
      </select>
    </label>
  </div>
  <div id="scoreboard-table-area"></div>
</section>

<!-- CONTROL PANEL (Registration & Logging) -->
<section id="control-panel">
  <h2>Control Panel</h2>
  <div style="margin-bottom:1rem;color:#1976d2;" id="ctl-event-desc"></div>
  <div class="filters">
    <label>Show Category:
      <select id="reg-cat-filter" multiple size="1"></select>
    </label>
    <label>Show Division:
      <select id="reg-div-filter" multiple>
        <option value="A" selected>A</option>
        <option value="B" selected>B</option>
      </select>
    </label>
  </div>
  <div id="registration-area">
    <form id="reg-form">
      <fieldset>
        <legend>Add New Lifter</legend>
        <label>Name:<input required id="reg-name"></label>
        <label>Team/College:<input id="reg-team"></label>
        <label>Bodyweight (kg):<input required type="number" step="0.1" min="1" id="reg-bw"></label>
        <label>Date of Birth:<input required type="date" id="reg-dob"></label>
        <label>Category:<select id="reg-category"></select></label>
        <label>Division:<select id="reg-division"><option value="A">A</option><option value="B">B</option></select></label>
        <div id="olympic-inputs">
          <label>1st Snatch (kg):<input type="number" min="0" step="0.5" id="reg-snatch"></label>
          <label>1st Clean & Jerk (kg):<input type="number" min="0" step="0.5" id="reg-cj"></label>
        </div>
        <div id="powerlifting-inputs" style="display:none;">
          <label>1st Squat (kg):<input type="number" min="0" step="0.5" id="reg-squat"></label>
          <label>1st Bench Press (kg):<input type="number" min="0" step="0.5" id="reg-bench"></label>
          <label>1st Deadlift (kg):<input type="number" min="0" step="0.5" id="reg-deadlift"></label>
        </div>
        <button type="submit">Add Lifter</button>
      </fieldset>
    </form>
    <div id="registered-lifters"></div>
  </div>
  <div id="logging-area" style="margin-top:2rem;"></div>
  <fieldset>
    <legend>Timer (syncs to Audience display)</legend>
    <input type="number" id="ctl-timer-len" value="60" min="10" max="180"> seconds
    <button id="ctl-timer-start">Start</button>
    <button id="ctl-timer-pause">Pause</button>
    <button id="ctl-timer-reset">Reset</button>
    <span class="timer-display" id="ctl-timer">60</span>
  </fieldset>
</section>
<script>
  // Persistent state (per event type)
  const state = {
    olympic: { categories: [], lifters: [], attempts: [] },
    powerlifting: { categories: [], lifters: [], attempts: [] },
    currentType: null,
    competitionName: '',
    logging: {currentLifter: null, currentAttempt: null},
    timer: {val:60, running:false, interval: null}
  };

  // Helper: Sinclair and Wilks
  function sinclairScore(total, bw, gender='M'){
    // 2024 A/B coefficients
    let a=0.75194503,b=175.508;
    if(gender=='F'){ a=0.783497476; b=153.655;}
    if(!total || !bw) return 0;
    if(bw > b) return total;
    let coeff = Math.pow(10, a * Math.pow(Math.log10(bw/b),2));
    return total*coeff;
  }
  function wilksScore(total, bw, gender='M'){
    let c = gender==="M"
      ? [-216.0475144, 16.2606339, -0.002388645, -0.00113732, 7.01863e-06, -1.291e-08]
      : [594.31747775582,-27.23842536447,0.82112226871,-0.00930733913,4.731582e-05,-9.054e-08];
    if(!bw || !total) return 0;
    let d = c[0] + c[1]*bw + c[2]*bw**2 + c[3]*bw**3 + c[4]*bw**4 + c[5]*bw**5;
    return d===0 ? 0 : total*500/d;
  }
  // UI Init
  function switchSection(id) {
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));
    if(id==="main-menu") document.getElementById('nav-main').classList.add('active');
    if(id==="audience-display") document.getElementById('nav-audience').classList.add('active');
    if(id==="scoreboard-display") document.getElementById('nav-scoreboard').classList.add('active');
    if(id==="control-panel") document.getElementById('nav-control').classList.add('active');
    // Sync timer
    updateAudienceDisplay();
    updateScoreboard();
    updateRegisteredLifters();
    updateLoggingArea();
  }
  ["nav-main","nav-audience","nav-scoreboard","nav-control","menu-link-audience","menu-link-scoreboard","menu-link-control"].forEach(id=>{
    let e = document.getElementById(id);
    if(e) e.onclick=(ev)=>{ ev.preventDefault(); switchSection(id.replace(/^nav-|^menu-link-/,'').replace("-display","").replace("-panel","-panel"));};
  });

  // Event setup
  document.getElementById('event-type-select').onchange=function(){
    let v=this.value;
    state.currentType=v;
    document.getElementById('event-setup-area').style.display = v ? 'block':'none';
    if(v) {
      document.getElementById('olympic-inputs').style.display = v==="olympic"?"block":"none";
      document.getElementById('powerlifting-inputs').style.display = v==="powerlifting"?"block":"none";
    }
  };
  document.getElementById('setup-confirm-btn').onclick=function(){
    let catStr=document.getElementById('category-list').value;
    let cats = catStr.split(',').map(c=>c.trim()).filter(Boolean);
    if(!state.currentType || cats.length===0) {
      document.getElementById('setup-msg').textContent="Please select event type and add at least one category!";
      return;
    }
    state[state.currentType].categories = cats;
    state[state.currentType].lifters = [];
    state[state.currentType].attempts = [];
    state.competitionName= document.getElementById('competition-name').value;
    populateCatFilters();
    populateRegCatOptions();
    document.getElementById('ctl-event-desc').textContent = `Current Event: ${state.competitionName || '[unnamed]'} (${state.currentType==="olympic"?"Olympic Weightlifting":"Powerlifting"})`;
    document.getElementById('setup-msg').textContent="Setup complete! Go to Control Panel to add lifters.";
  };

  function populateRegCatOptions() {
    let sel = document.getElementById('reg-category');
    sel.innerHTML = '';
    let cats = state[state.currentType]?.categories || [];
    cats.forEach(c=>{
      let o=document.createElement('option');
      o.value=c;o.textContent=c+" kg";
      sel.appendChild(o);
    });
  }

  // Registration form
  document.getElementById('reg-form').onsubmit=function(e){
    e.preventDefault();
    let ty = state.currentType;
    let out = {
      name: document.getElementById('reg-name').value,
      team: document.getElementById('reg-team').value,
      bodyweight: parseFloat(document.getElementById('reg-bw').value),
      dob: document.getElementById('reg-dob').value,
      category: document.getElementById('reg-category').value,
      division: document.getElementById('reg-division').value,
      gender: 'M', // for now, add gender input as feature later
    };
    if(ty==="olympic"){
      out.firstLifts = [
        parseFloat(document.getElementById('reg-snatch').value)||0,
        parseFloat(document.getElementById('reg-cj').value)||0
      ];
    } else {
      out.firstLifts = [
        parseFloat(document.getElementById('reg-squat').value)||0,
        parseFloat(document.getElementById('reg-bench').value)||0,
        parseFloat(document.getElementById('reg-deadlift').value)||0
      ];
    }
    out.attempts=[]; out.total=0;
    state[ty].lifters.push(out);
    updateRegisteredLifters();
    this.reset();
  };

  // Filters
  function populateCatFilters(){
    ["score-cat-filter","reg-cat-filter"].forEach(id=>{
      let sel = document.getElementById(id);
      sel.innerHTML='';
      let cats = state[state.currentType]?.categories||[];
      cats.forEach(c=>{
        let opt=document.createElement('option');
        opt.value=c; opt.textContent=c+" kg"; opt.selected=true;
        sel.appendChild(opt);
      });
    });
  }
  function getSelectedFilter(selId) {
    let sel = document.getElementById(selId);
    return Array.from(sel.selectedOptions).map(x=>x.value);
  }

  // Registered Lifters: filterable/grouped view
  function updateRegisteredLifters() {
    let ty = state.currentType;
    let disp=document.getElementById('registered-lifters');
    let lifters = state[ty].lifters;
    let cats = getSelectedFilter('reg-cat-filter');
    let divs = getSelectedFilter('reg-div-filter');
    let catsSet = new Set(cats);
    let divsSet = new Set(divs);
    let html = '';
    let grouped = {};
    lifters.forEach(l=>{
      if(!catsSet.has(l.category)||!divsSet.has(l.division)) return;
      if(!grouped[l.category]) grouped[l.category]={};
      if(!grouped[l.category][l.division]) grouped[l.category][l.division]=[];
      grouped[l.category][l.division].push(l);
    });
    Object.keys(grouped).sort((a,b)=>parseFloat(a)-parseFloat(b)).forEach(cat=>{
      html+=`<tr class="cat-header"><td colspan="99">${cat} kg</td></tr>`;
      Object.keys(grouped[cat]).sort().forEach(div=>{
        html+=`<tr class="div-header"><td colspan="99">Division ${div}</td></tr>`;
        html+=`<tr><th>Name</th><th>Team</th><th>Wt</th><th>DOB</th>`;
        if(ty==="olympic")html+=`<th>1st Snatch</th><th>1st C&J</th>`;
        else html+=`<th>1st Sq</th><th>1st Bench</th><th>1st DL</th>`;
        html+=`</tr>`;
        grouped[cat][div].forEach(l=>{
          html+=`<tr><td>${l.name}</td><td>${l.team}</td><td>${l.bodyweight}</td><td>${l.dob}</td>`;
          if(ty==="olympic")
            html+=`<td>${l.firstLifts[0]}</td><td>${l.firstLifts[1]}</td>`;
          else
            html+=`<td>${l.firstLifts[0]}</td><td>${l.firstLifts[1]}</td><td>${l.firstLifts[2]}</td>`;
          html+=`</tr>`;
        });
      });
    });
    disp.innerHTML = `<table>${html}</table>`;
  }
  document.getElementById('reg-cat-filter').onchange=updateRegisteredLifters;
  document.getElementById('reg-div-filter').onchange=updateRegisteredLifters;

  // Scoreboard: group by cat/div and filter
  function updateScoreboard(){
    let ty = state.currentType;
    let lifters = state[ty].lifters;
    let cats = getSelectedFilter('score-cat-filter');
    let divs= getSelectedFilter('score-div-filter');
    let catsSet=new Set(cats), divsSet=new Set(divs);
    let out={};
    lifters.forEach(l=>{
      if(!catsSet.has(l.category)||!divsSet.has(l.division)) return;
      if(!out[l.category]) out[l.category]={};
      if(!out[l.category][l.division]) out[l.category][l.division]=[];
      out[l.category][l.division].push(l);
    });
    let html='';
    Object.keys(out).sort((a,b)=>parseFloat(a)-parseFloat(b)).forEach(cat=>{
      html+=`<tr class="cat-header"><td colspan="99">${cat} kg</td></tr>`;
      Object.keys(out[cat]).sort().forEach(div=>{
        html+=`<tr class="div-header"><td colspan="99">Division ${div}</td></tr>`;
        html+=`<tr><th>Name</th><th>DOB</th><th>Team</th><th>Bodyweight</th>`;
        if(ty==="olympic") html+=`<th>Snatch</th><th>C&J</th>`;
        else html+=`<th>Squat</th><th>Bench</th><th>DL</th>`;
        html+=`<th>Total</th><th>${ty==="olympic"?"Sinclair":"Wilks"}</th><th>Rank</th></tr>`;
        out[cat][div].forEach(l=>{
          let total=0, score=0, rk='-';
          if(l.attempts && l.attempts.length){
            if(ty==="olympic")
              total=l.attempts.reduce((s,a)=>s+(a.status==='good'?a.weight:0),0);
            else
              total=l.attempts.reduce((s,a)=>s+(a.status==='good'?a.weight:0),0);
            score=ty==="olympic"?sinclairScore(total,l.bodyweight):wilksScore(total,l.bodyweight);
          }
          html+=`<tr><td>${l.name}</td><td>${l.dob}</td><td>${l.team}</td><td>${l.bodyweight}</td>`;
          if(ty==="olympic")
            html+=`<td>${l.firstLifts[0]}</td><td>${l.firstLifts[1]}</td>`;
          else
            html+=`<td>${l.firstLifts[0]}</td><td>${l.firstLifts[1]}</td><td>${l.firstLifts[2]}</td>`;
          html+=`<td>${total||"-"}</td><td>${score?score.toFixed(2):"-"}</td><td>${rk}</td></tr>`;
        });
      });
    });
    document.getElementById('scoreboard-table-area').innerHTML = `<table>${html}</table>`;
  }
  document.getElementById('score-cat-filter').onchange=updateScoreboard;
  document.getElementById('score-div-filter').onchange=updateScoreboard;


  // Attempt Logging (with buttons)
  function updateLoggingArea(){
    const area = document.getElementById('logging-area');
    const ty = state.currentType;
    const lifters = state[ty].lifters;
    if(lifters.length===0){ area.innerHTML =""; return;}
    // Select current lifter
    let idx=state.logging.currentLifter||0;
    if(idx>=lifters.length) idx=0;
    let l=lifters[idx];
    area.innerHTML = `<fieldset>
    <legend>Attempt Logging</legend>
    <div>Current Lifter: <strong>${l.name} (${l.category}kg Div ${l.division})</strong></div>
    <div>Bodyweight: ${l.bodyweight} kg | DOB: ${l.dob}</div>
    <div>Next Attempt: <span id="log-attempt-amt">${l.firstLifts[0]}</span> kg</div>
    <div class="barbell" id="ctl-barbell"></div>
    <div style="margin-top:0.8rem">
      <button class="decision-good" onclick="finalizeAttempt('good')">Good Lift</button>
      <button class="decision-no" onclick="finalizeAttempt('no')">No Lift</button>
      <button class="decision-review" onclick="finalizeAttempt('review')">Under Review</button>
    </div>
    <div style="margin-top:1rem">
      <button onclick="prevLifter()">Prev Lifter</button>
      <button onclick="nextLifter()">Next Lifter</button>
    </div>
    </fieldset>`;
    updateBarbellDisplay('ctl-barbell',l.firstLifts[0]);
  }

  // Audience Display (sync from logging)
  function updateAudienceDisplay(){
    const ty=state.currentType;const lifters=state[ty].lifters;
    let idx=state.logging.currentLifter||0,l=lifters[idx];
    document.getElementById('aud-cur-lifter').textContent=l?l.name:"---";
    document.getElementById('aud-cur-weight').textContent=l?l.firstLifts[0]:"---";
    document.getElementById('aud-decision').textContent="Waiting";
    updateBarbellDisplay('aud-barbell',l?l.firstLifts[0]:0);
    // Timer sync
    document.getElementById('aud-timer').textContent=state.timer.val;
  }

  function updateBarbellDisplay(id,weight){
    let target = document.getElementById(id);
    const barWeight = 20, collar = 5;
    if(weight < barWeight + collar){ target.innerHTML='No plates loaded'; return; }
    let perSide = (weight-barWeight-collar)/2, plates=[],
    defs=[{w:25,c:'red'},{w:20,c:'blue'},{w:15,c:'yellow'},{w:10,c:'green'},{w:5,c:'white'},{w:2.5,c:'red'},{w:2,c:'blue'},{w:1.5,c:'yellow'},{w:1,c:'green'},{w:0.5,c:'white'}];
    for(let pd of defs){
      while(perSide>=pd.w-0.01){
        plates.push(pd);perSide-=pd.w;perSide=+perSide.toFixed(2);
      }
    }
    let html=`<span class="plate gray">Collar</span>`;
    plates.forEach(pl=>html+=`<span class="plate ${pl.c}">${pl.w}</span>`);
    target.innerHTML=html;
  }

  // Attempt logging events/global
  window.finalizeAttempt=function(decision){
    let ty=state.currentType, lifters=state[ty].lifters, idx=state.logging.currentLifter||0, l=lifters[idx];
    if(!l)return;
    l.attempts.push({weight:l.firstLifts[0],status:decision});
    document.getElementById('aud-decision').textContent = decision==="good"?"Good Lift":decision==="no"?"No Lift":"Under Review";
    updateScoreboard();
    nextLifter();
  };
  window.prevLifter=function(){
    let ty=state.currentType, lifters=state[ty].lifters, idx=state.logging.currentLifter||0;
    if(idx>0) state.logging.currentLifter=idx-1;
    else state.logging.currentLifter=lifters.length-1;
    updateLoggingArea();updateAudienceDisplay();
  };
  window.nextLifter=function(){
    let ty=state.currentType, lifters=state[ty].lifters, idx=state.logging.currentLifter||0;
    if(idx<lifters.length-1) state.logging.currentLifter=idx+1;
    else state.logging.currentLifter=0;
    updateLoggingArea();updateAudienceDisplay();
  };

  // Timer controls (sync to both Control & Audience Display)
  function timerSyncViews(){ document.getElementById('ctl-timer').textContent=state.timer.val; document.getElementById('aud-timer').textContent=state.timer.val; }
  document.getElementById('ctl-timer-start').onclick=function(){
    if(state.timer.running)return;
    state.timer.running=true;
    state.timer.interval=setInterval(()=>{state.timer.val--; timerSyncViews();if(state.timer.val<=0){clearInterval(state.timer.interval);state.timer.running=false;}},1000);
  };
  document.getElementById('ctl-timer-pause').onclick=function(){
    state.timer.running=false;clearInterval(state.timer.interval);
  };
  document.getElementById('ctl-timer-reset').onclick=function(){
    state.timer.val=parseInt(document.getElementById('ctl-timer-len').value)||60;timerSyncViews();
  };

  // INIT: On Hash Change/Load
  window.onhashchange=function(){
    if(location.hash==="#audience") switchSection("audience-display");
    else if(location.hash==="#scoreboard")switchSection("scoreboard-display");
    else if(location.hash==="#control")switchSection("control-panel");
    else switchSection("main-menu");
  };
  window.onload = window.onhashchange;

</script>
</body>
</html>
