<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DualLift-Scoreboard v2</title>
<style>
  body { font-family: Arial, sans-serif; background: #fafafa; margin: 0; padding: 0; }
  #app { max-width: 1200px; margin: 0 auto; padding: 10px; }
  header { text-align: center; padding: 1rem 0; background: #1976d2; color: white; }
  nav { display: flex; background: #eee; border-bottom: 1px solid #ccc; }
  nav button { flex:1; padding: 12px; border:none; background:none; cursor:pointer; font-weight: bold; }
  nav button.active { background: #1976d2; color: white; }
  section { padding: 10px; background: white; min-height: 400px; display: none; }
  section.active { display: block; }
  label { display:block; margin-top: 0.5rem; }
  input, select, button { margin-top: 0.25rem; padding: 6px; width: 100%; max-width: 300px; box-sizing: border-box; }
  table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
  th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
  th { background: #f0f0f0; }
  .decision-good { color: green; font-weight: bold; }
  .decision-no { color: red; font-weight: bold; }
  .decision-review { color: goldenrod; font-weight: bold; }
  #barbell-visual { margin: 1rem 0; display: flex; align-items: center; }
  .plate { border-radius: 3px; margin-right: 4px; padding: 2px 6px; color: white; font-weight: bold; font-size: 0.8rem; min-width: 32px; text-align: center; }
  .red { background: #d32f2f; }
  .blue { background: #1976d2; }
  .yellow { background: #fbc02d; color:#333; }
  .green { background: #388e3c; }
  .white { background: #fafafa; color:#333; border: 1px solid #999; }
  .gray { background: #666; }
  .timer-display { font-size: 3rem; font-weight: bold; text-align: center; margin: 1rem 0; }
  fieldset { border: 1px solid #ccc; padding: 10px; margin-top: 1rem; }
  button.control-btn { max-width: 150px; margin-top: 10px; }
  .flex-row { display: flex; gap: 1rem; flex-wrap: wrap; }
  .flex-grow { flex-grow: 1; min-width: 280px; }
  @media(min-width: 700px) {
    .half { flex: 1; }
  }
</style>
</head>
<body>

<div id="app">
  <header><h1>DualLift-Scoreboard</h1></header>
  <nav>
    <button id="tab-setup" class="active">Setup</button>
    <button id="tab-audience">Audience Display</button>
    <button id="tab-scoreboard">Scoreboard</button>
    <button id="tab-control">Control Panel</button>
  </nav>

  <!-- Setup Screen -->
  <section id="setup-section" class="active">
    <h2>Competition Setup</h2>
    <label>
      Select Event Type:
      <select id="event-type">
        <option value="" disabled selected>Select event</option>
        <option value="olympic">Olympic Weightlifting</option>
        <option value="powerlifting">Powerlifting</option>
      </select>
    </label>
    <label>
      Competition Name:
      <input type="text" id="competition-name" placeholder="Enter competition name" />
    </label>
    <label>
      Weight Categories (comma separated):
      <input type="text" id="weight-categories" placeholder="e.g. 61,73,81" />
    </label>

    <button id="start-registration-btn">Start Registration</button>
  </section>

  <!-- Audience Display -->
  <section id="audience-section">
    <h2>Audience Display</h2>
    <div>
      <strong>Current Lifter:</strong> <span id="current-lifter-name-aud">---</span><br/>
      <strong>Attempt Weight:</strong> <span id="current-weight-aud">---</span> kg
    </div>
    <div id="barbell-visual"></div>
    <div class="timer-display" id="timer-display-aud">60</div>
    <div><strong>Referee Decision:</strong> <span id="referee-decision-aud">Waiting</span></div>
  </section>

  <!-- Scoreboard -->
  <section id="scoreboard-section">
    <h2>Scoreboard</h2>
    <table>
      <thead>
        <tr>
          <th>#</th><th>Name</th><th>DOB</th><th>Team</th><th>Division</th><th>Category</th>
          <th>Attempt 1</th><th>Attempt 2</th><th>Attempt 3</th>
          <th>Total</th><th>Sinclair/Wilks</th><th>Rank</th>
        </tr>
      </thead>
      <tbody id="scoreboard-tbody"></tbody>
    </table>
  </section>

  <!-- Control Panel -->
  <section id="control-section">
    <h2>Control Panel</h2>

    <div id="registration-area" style="display:none;">
      <h3>Register Lifters</h3>
      <form id="lifter-form">
        <label>Name:<input type="text" id="lifter-name" required /></label>
        <label>Team/College:<input type="text" id="lifter-team" /></label>
        <label>Bodyweight (kg):<input type="number" id="lifter-bodyweight" step="0.1" required /></label>
        <label>Date of Birth:<input type="date" id="lifter-dob" required /></label>
        <label>Category:<select id="lifter-category"></select></label>
        <label>Division:
          <select id="lifter-division" required>
            <option value="A">A</option><option value="B">B</option>
          </select>
        </label>

        <!-- Lift inputs based on event -->
        <div id="olympic-firstlifts-input" style="display:none;">
          <label>First Snatch (kg):<input type="number" id="first-snatch" step="0.5" min="0"/></label>
          <label>First Clean & Jerk (kg):<input type="number" id="first-cj" step="0.5" min="0"/></label>
        </div>

        <div id="powerlifting-firstlifts-input" style="display:none;">
          <label>First Squat (kg):<input type="number" id="first-squat" step="0.5" min="0"/></label>
          <label>First Bench Press (kg):<input type="number" id="first-bench" step="0.5" min="0"/></label>
          <label>First Deadlift (kg):<input type="number" id="first-deadlift" step="0.5" min="0"/></label>
        </div>

        <button type="submit">Add Lifter</button>
      </form>

      <hr/>
      <h3>Registered Lifters</h3>
      <table>
        <thead>
          <tr><th>#</th><th>Name</th><th>Team</th><th>Bodyweight</th><th>DOB</th><th>Category</th><th>Division</th><th>1st Lifts Total</th></tr>
        </thead>
        <tbody id="lifters-tbody"></tbody>
      </table>

      <button id="start-competition-btn" disabled>Start Competition</button>
    </div>

    <div id="attempt-logging-area" style="display:none;">
      <h3>Log Attempts for: <span id="current-lifter-name-control"></span></h3>
      <div><strong>Current Attempt Weight:</strong> <span id="current-weight-control">---</span> kg</div>
      <div id="barbell-visual-control"></div>

      <div>
        <button class="control-btn" data-status="good">Good Lift</button>
        <button class="control-btn" data-status="no">No Lift</button>
        <button class="control-btn" data-status="review">Under Review</button>
      </div>
    </div>

    <fieldset>
      <legend>Timer Controls</legend>
      <label>Time (seconds): <input type="number" id="timer-length-control" value="60" min="10" max="180"></label><br/>
      <button id="timer-start-btn">Start</button>
      <button id="timer-pause-btn">Pause</button>
      <button id="timer-reset-btn">Reset</button>
      <div class="timer-display" id="timer-display-control">60</div>
    </fieldset>
  </section>
</div>

<script>
  // State variables
  let lifters = [];
  let currentEvent = '';
  let currentCategories = [];
  let currentLifterIndex = 0;
  let timerValue = 60;
  let timerInterval = null;
  let timerRunning = false;

  // Sinclair calculation constants
  const SINCLAIR_COEFFICIENTS = {
    2024: {
      M: { a: 0.75194503, b: 175.508 },
      F: { a: 0.783497476, b: 153.655 }
    }
  };

  // Wilks formula constants (IPF formula version)
  const WILKS_CONSTANTS = {
    M: { a: -216.0475144, b: 16.2606339, c: -0.002388645, d: -0.00113732, e: 7.01863e-06, f: -1.291e-08 },
    F: { a: 594.31747775582, b: -27.23842536447, c: 0.82112226871, d: -0.00930733913, e: 4.731582e-05, f: -9.054e-08 }
  };

  // DOM references
  const tabButtons = {
    setup: document.getElementById('tab-setup'),
    audience: document.getElementById('tab-audience'),
    scoreboard: document.getElementById('tab-scoreboard'),
    control: document.getElementById('tab-control')
  };
  const sections = {
    setup: document.getElementById('setup-section'),
    audience: document.getElementById('audience-section'),
    scoreboard: document.getElementById('scoreboard-section'),
    control: document.getElementById('control-section')
  };

  function switchTab(tab) {
    Object.keys(sections).forEach(key => {
      sections[key].classList.toggle('active', key === tab);
      tabButtons[key].classList.toggle('active', key === tab);
    });
  }

  // Initialize event listeners for tab switching
  Object.entries(tabButtons).forEach(([key, btn]) => {
    btn.addEventListener('click', () => switchTab(key));
  });

  // Setup phase
  document.getElementById('start-registration-btn').addEventListener('click', () => {
    const eventType = document.getElementById('event-type').value;
    const compName = document.getElementById('competition-name').value.trim();
    const catInput = document.getElementById('weight-categories').value.trim();

    if (!eventType || !compName || !catInput) {
      alert('Please fill all competition setup fields!');
      return;
    }
    currentEvent = eventType;
    currentCategories = catInput.split(',').map(x => x.trim());

    // Show appropriate first lifts input
    document.getElementById('olympic-firstlifts-input').style.display = (currentEvent === 'olympic') ? 'block' : 'none';
    document.getElementById('powerlifting-firstlifts-input').style.display = (currentEvent === 'powerlifting') ? 'block' : 'none';

    const categorySelect = document.getElementById('lifter-category');
    categorySelect.innerHTML = '';
    currentCategories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat + ' kg';
      categorySelect.appendChild(option);
    });

    document.getElementById('registration-area').style.display = 'block';
    switchTab('control');
  });

  // Lifter registration
  document.getElementById('lifter-form').addEventListener('submit', e => {
    e.preventDefault();
    const name = document.getElementById('lifter-name').value.trim();
    const team = document.getElementById('lifter-team').value.trim();
    const bodyweight = parseFloat(document.getElementById('lifter-bodyweight').value);
    const dob = document.getElementById('lifter-dob').value;
    const category = document.getElementById('lifter-category').value;
    const division = document.getElementById('lifter-division').value;

    let firstLifts = [];
    if (currentEvent === 'olympic') {
      let snatch = parseFloat(document.getElementById('first-snatch').value) || 0;
      let cj = parseFloat(document.getElementById('first-cj').value) || 0;
      firstLifts = [snatch, cj];
    } else if(currentEvent === 'powerlifting') {
      let squat = parseFloat(document.getElementById('first-squat').value) || 0;
      let bench = parseFloat(document.getElementById('first-bench').value) || 0;
      let deadlift = parseFloat(document.getElementById('first-deadlift').value) || 0;
      firstLifts = [squat, bench, deadlift];
    }

    let totalFirst = firstLifts.reduce((a,b)=> a+b, 0);

    lifters.push({
      name, team, bodyweight, dob, category, division,
      firstLifts, totalFirst,
      attempts: [],
      total: 0,
      rank: null,
      sinclairWilks: 0
    });
    updateLiftersTable();
    e.target.reset();
    document.getElementById('start-competition-btn').disabled = false;
  });

  function updateLiftersTable(){
    const tbody = document.getElementById('lifters-tbody');
    tbody.innerHTML = '';
    lifters.forEach((l, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${idx+1}</td><td>${l.name}</td><td>${l.team}</td><td>${l.bodyweight.toFixed(1)}</td><td>${l.dob}</td><td>${l.category}</td><td>${l.division}</td><td>${l.totalFirst.toFixed(1)}</td>`;
      tbody.appendChild(tr);
    });
  }

  // Start competition button
  document.getElementById('start-competition-btn').addEventListener('click', () => {
    if(lifters.length === 0) {
      alert('Add lifters before starting competition!');
      return;
    }
    // Sort lifters by totalFirst descending and assign starting numbers
    lifters.sort((a,b) => b.totalFirst - a.totalFirst);
    lifters.forEach((l, idx) => l.startingNumber = idx+1);
    currentLifterIndex = 0;
    updateScoreboard();
    switchTab('control');
    showAttemptLoggingForCurrent();
    document.getElementById('registration-area').style.display = 'none';
    document.getElementById('attempt-logging-area').style.display = 'block';
    updateAudienceDisplay();
  });

  // Show attempt logging controls for current lifter
  function showAttemptLoggingForCurrent() {
    const lifter = lifters[currentLifterIndex];
    if(!lifter) return;
    document.getElementById('current-lifter-name-control').textContent = lifter.name;
    // Determine next attempt weight to display: for Olympic, sum or respective; for powerlifting, TBD by user input
    // Here we just show 0 initially and update on attempt log
    document.getElementById('current-weight-control').textContent = '---';
    updateBarbellVisualControl(0);
    setRefereeDecision('Waiting');
  }

  // Log attempts (via buttons)
  document.querySelectorAll('#attempt-logging-area button.control-btn').forEach(btn=>{
    btn.addEventListener('click', (e) => {
      const status = e.target.getAttribute('data-status');
      logAttempt(status);
    });
  });

  function logAttempt(status) {
    if(currentLifterIndex >= lifters.length) return;

    // Use the weight shown on control (simulate input for now by using last logged or first lift)
    const weightText = document.getElementById('current-weight-control').textContent;
    let weight = parseFloat(weightText);
    // For now if no weight, we can default to first attempt weight or 0
    if(isNaN(weight)) weight = lifters[currentLifterIndex].firstLifts[0] || 0;

    const lifter = lifters[currentLifterIndex];

    // Log attempt details
    let attemptNum = lifter.attempts.length;

    // Limit attempts to 3 per lifter per event (adjust if needed for event type)
    if (attemptNum >= 3) {
      alert('All attempts logged for this lifter');
      return;
    }

    lifter.attempts.push({weight,status});
    if(status === 'good') lifter.total += weight;

    updateScoreboard();

    // Move to next lifter or finish
    currentLifterIndex++;
    if(currentLifterIndex >= lifters.length) {
      finalizeCompetition();
    } else {
      showAttemptLoggingForCurrent();
      updateAudienceDisplay();
    }
  }

  // Update Audience Display info and barbell visualization
  function updateAudienceDisplay() {
    if(currentLifterIndex >= lifters.length) {
      document.getElementById('current-lifter-name-aud').textContent = 'Competition Finished';
      document.getElementById('current-weight-aud').textContent = '-';
      document.getElementById('referee-decision-aud').textContent = '-';
      updateBarbellVisual(0, 'barbell-visual');
      return;
    }
    const lifter = lifters[currentLifterIndex];
    document.getElementById('current-lifter-name-aud').textContent = lifter.name;
    const nextWeight = lifter.firstLifts[0] || 0;
    document.getElementById('current-weight-aud').textContent = nextWeight.toFixed(1);
    updateBarbellVisual(nextWeight, 'barbell-visual');
    document.getElementById('referee-decision-aud').textContent = 'Waiting';
  }

  // Update Scoreboard
  function updateScoreboard() {
    const tbody = document.getElementById('scoreboard-tbody');
    tbody.innerHTML = '';
    lifters.forEach(lifter => {
      let attemptsDisplay = [null,null,null];
      lifter.attempts.forEach((a,i)=> {
        if(i>2) return;
        let cls = '';
        if (a.status === 'good') cls = 'decision-good';
        else if (a.status === 'no') cls = 'decision-no';
        else if (a.status === 'review') cls = 'decision-review';
        attemptsDisplay[i] = `<span class="${cls}">${a.weight} kg</span>`;
      });
      while(attemptsDisplay.length < 3) attemptsDisplay.push('-');

      // Calculate Sinclair or Wilks score depending on event and gender (assuming male for demo)
      let score = 0;
      if(currentEvent === 'olympic') {
        score = calculateSinclair(lifter.total, lifter.bodyweight, 'M');
      } else if(currentEvent === 'powerlifting') {
        score = calculateWilks(lifter.total, lifter.bodyweight, 'M');
      }
      lifter.sinclairWilks = score;

      tbody.innerHTML += `<tr>
        <td>${lifter.startingNumber}</td>
        <td>${lifter.name}</td>
        <td>${lifter.dob}</td>
        <td>${lifter.team}</td>
        <td>${lifter.division}</td>
        <td>${lifter.category}</td>
        <td>${attemptsDisplay[0]}</td><td>${attemptsDisplay[1]}</td><td>${attemptsDisplay[2]}</td>
        <td>${lifter.total.toFixed(1)}</td><td>${score.toFixed(2)}</td><td>${lifter.rank || '-'}</td>
      </tr>`;
    });
  }

  // Finalize competition: assign ranks after all attempts logged
  function finalizeCompetition() {
    lifters.sort((a,b) => b.total - a.total);
    lifters.forEach((l, idx) => l.rank = idx+1);
    updateScoreboard();
    alert('Competition Complete! Final ranks updated.');
    switchTab('scoreboard');
  }

  // Timer logic
  function updateTimerDisplay(timeSec, id) {
    document.getElementById(id).textContent = timeSec;
  }
  function startTimer() {
    if(timerRunning) return;
    timerRunning = true;
    timerInterval = setInterval(() => {
      if(timerValue <= 0) {
        stopTimer();
        return;
      }
      timerValue--;
      updateTimerDisplay(timerValue, 'timer-display-control');
      updateTimerDisplay(timerValue, 'timer-display-aud');
    }, 1000);
  }
  function pauseTimer() {
    timerRunning = false;
    clearInterval(timerInterval);
  }
  function resetTimer() {
    pauseTimer();
    timerValue = parseInt(document.getElementById('timer-length-control').value, 10) || 60;
    updateTimerDisplay(timerValue, 'timer-display-control');
    updateTimerDisplay(timerValue, 'timer-display-aud');
  }

  document.getElementById('timer-start-btn').addEventListener('click', startTimer);
  document.getElementById('timer-pause-btn').addEventListener('click', pauseTimer);
  document.getElementById('timer-reset-btn').addEventListener('click', resetTimer);

  // Update barbell visual on control and audience displays
  function updateBarbellVisual(weight, containerId='barbell-visual-control') {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    const barWeight = 20;
    const collarWeight = 5;
    if(weight < barWeight + collarWeight){
      container.textContent = 'No plates loaded';
      return;
    }
    const weightPerSide = (weight - barWeight - collarWeight)/2;
    if(weightPerSide <= 0){
      container.textContent = 'No plates loaded';
      return;
    }

    // Plates in loading order: 25,20,15,10,5,2.5,collar,2,1.5,1,0.5 (simplified colors)
    // Collar included separately in display as fixed gray plate
    const plateDefs = [
      {weight:25,color:'red'},
      {weight:20,color:'blue'},
      {weight:15,color:'yellow'},
      {weight:10,color:'green'},
      {weight:5,color:'white'},
      {weight:2.5,color:'red'},
      // collar position here visually separate
      {weight:2,color:'blue'},
      {weight:1.5,color:'yellow'},
      {weight:1,color:'green'},
      {weight:0.5,color:'white'}
    ];

    // Calculate plates to load per side
    let remaining = weightPerSide;
    let plates = [];
    for(let pd of plateDefs){
      while(remaining >= pd.weight - 1e-6){ // tolerance for float math
        plates.push(pd);
        remaining -= pd.weight;
        remaining = Math.round(remaining*100)/100;
      }
    }

    // Show plates outside collar first (biggest first)
    const outsidePlates = plates.filter(p=>p.weight >= 2.5);
    outsidePlates.sort((a,b) => b.weight - a.weight);

    // Collar lock
    const collar = document.createElement('span');
    collar.className = 'plate gray';
    collar.textContent = 'Collar';
    collar.title = '2.5 kg collar lock';
    container.appendChild(collar);

    // Outside plates (descending)
    outsidePlates.forEach(pl => {
      const sp = document.createElement('span');
      sp.className = 'plate '+pl.color;
      sp.textContent = pl.weight;
      sp.title = pl.weight + ' kg plate outside collar';
      container.appendChild(sp);
    });

    // Inside plates (smallest below 2.5)
    const insidePlates = plates.filter(p=>p.weight < 2.5);
    insidePlates.sort((a,b) => a.weight - b.weight);
    insidePlates.forEach(pl => {
      const sp = document.createElement('span');
      sp.className = 'plate '+pl.color;
      sp.textContent = pl.weight;
      sp.title = pl.weight + ' kg plate inside collar';
      container.appendChild(sp);
    });
  }

  // Helper functions for Sinclair and Wilks calculations
  function calculateSinclair(total, bodyweight, gender='M'){
    if(total <= 0) return 0;
    let genderKey = gender === 'M' ? 'M' : 'F';
    let {a,b} = SINCLAIR_COEFFICIENTS[2024][genderKey];
    if(bodyweight > b) return total;
    let coeff = Math.pow(10, a * (Math.log10(bodyweight / b)) ** 2);
    return total * coeff;
  }

  function calculateWilks(total, bodyweight, gender='M'){
    if(total <= 0) return 0;
    let c = WILKS_CONSTANTS[gender === 'M' ? 'M' : 'F'];
    let bw = bodyweight;
    let denom = c.a + c.b * bw + c.c * bw ** 2 + c.d * bw ** 3 + c.e * bw ** 4 + c.f * bw ** 5;
    return total * (500 / denom);
  }
</script>

</body>
</html>
